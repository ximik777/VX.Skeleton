#!/usr/bin/env php

<?php

pcntl_signal(SIGINT, "out");

$ret = 0;

$actions = [
    'new',
    'help',
    'update'
];

$path = null;
$action = false;
$options = [];

$params = array(
    'h::' => 'help'
);

$options = getopt(implode('', array_keys($params)), $params );


if($options) {
    call_user_func('Action_main', $options);
}

foreach ($argv as $k=>$v) {
    if(in_array($v, $actions)) {
        $action = $v;
    }
}

if(!$action || $action == 'help') {
    out('help');
}

switch ($action) {
    case 'new':
        for($i = 0; $i<$argc; $i++) {
            if($argv[$i] = 'new') {
                $path = $argv[$i+1];
                Action_new($path);
            }
        }
        break;
    case 'update':
        $path = realpath($argv[0]);
        Action_update($path);
        break;
}

call_user_func('Action_'.$action);

function Action_main($options) {

    switch (array_keys($options)) {
        default:
        case 'h' :
        case 'help':
            out('help');
            break;

    }
}

function Action_new($path) {

    if(!$path) {
        out(1);
    }

    $tmp_dir = sys_get_temp_dir();

    file_put_contents($tmp_dir.'/VX.Skeleton.zip', fopen('https://github.com/ximik777/VX.Skeleton/archive/v0.0.0.zip', 'r'));

    if(!mkdir($path, 0775, true)){
        out(2);
    }

    $zip = new ZipArchive;
    $res = $zip->open($tmp_dir.'/VX.Skeleton.zip');
    if ($res === TRUE) {
        $zip->extractTo($path);
        $zip->close();
        echo "VX.Skeleton.zip extracted to $path";
    } else {
        out(3);
    }

    out(4);

}

function Action_update($path) {

//    $test = "IyEvdXNyL2Jpbi9lbnYgcGhwCgo8P3BocAoKcGNudGxfc2lnbmFsKFNJR0lO\nVCwgIm91dCIpOwoKJHJldCA9IDA7CgokYWN0aW9ucyA9IFsKICAgICduZXcn\nLAogICAgJ2hlbHAnLAogICAgJ3VwZGF0ZScKXTsKCiRwYXRoID0gbnVsbDsK\nJGFjdGlvbiA9IGZhbHNlOwokb3B0aW9ucyA9IFtdOwoKJHBhcmFtcyA9IGFy\ncmF5KAogICAgJ2g6OicgPT4gJ2hlbHAnCik7Cgokb3B0aW9ucyA9IGdldG9w\ndChpbXBsb2RlKCcnLCBhcnJheV9rZXlzKCRwYXJhbXMpKSwgJHBhcmFtcyAp\nOwoKCmlmKCRvcHRpb25zKSB7CiAgICBjYWxsX3VzZXJfZnVuYygnQWN0aW9u\nX21haW4nLCAkb3B0aW9ucyk7Cn0KCmZvcmVhY2ggKCRhcmd2IGFzICRrPT4k\ndikgewogICAgaWYoaW5fYXJyYXkoJHYsICRhY3Rpb25zKSkgewogICAgICAg\nICRhY3Rpb24gPSAkdjsKICAgIH0KfQoKaWYoISRhY3Rpb24gfHwgJGFjdGlv\nbiA9PSAnaGVscCcpIHsKICAgIG91dCgnaGVscCcpOwp9Cgpzd2l0Y2ggKCRh\nY3Rpb24pIHsKICAgIGNhc2UgJ25ldyc6CiAgICAgICAgZm9yKCRpID0gMDsg\nJGk8JGFyZ2M7ICRpKyspIHsKICAgICAgICAgICAgaWYoJGFyZ3ZbJGldID0g\nJ25ldycpIHsKICAgICAgICAgICAgICAgICRwYXRoID0gJGFyZ3ZbJGkrMV07\nCiAgICAgICAgICAgICAgICBBY3Rpb25fbmV3KCRwYXRoKTsKICAgICAgICAg\nICAgfQogICAgICAgIH0KICAgICAgICBicmVhazsKICAgIGNhc2UgJ3VwZGF0\nZSc6CiAgICAgICAgJHBhdGggPSByZWFscGF0aCgkYXJndlswXSk7CiAgICAg\nICAgQWN0aW9uX3VwZGF0ZSgkcGF0aCk7CiAgICAgICAgYnJlYWs7Cn0KCmNh\nbGxfdXNlcl9mdW5jKCdBY3Rpb25fJy4kYWN0aW9uKTsKCmZ1bmN0aW9uIEFj\ndGlvbl9tYWluKCRvcHRpb25zKSB7CgogICAgc3dpdGNoIChhcnJheV9rZXlz\nKCRvcHRpb25zKSkgewogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgY2FzZSAn\naCcgOgogICAgICAgIGNhc2UgJ2hlbHAnOgogICAgICAgICAgICBvdXQoJ2hl\nbHAnKTsKICAgICAgICAgICAgYnJlYWs7CgogICAgfQp9CgpmdW5jdGlvbiBB\nY3Rpb25fbmV3KCRwYXRoKSB7CgogICAgaWYoISRwYXRoKSB7CiAgICAgICAg\nb3V0KDEpOwogICAgfQoKICAgICR0bXBfZGlyID0gc3lzX2dldF90ZW1wX2Rp\ncigpOwoKICAgIGZpbGVfcHV0X2NvbnRlbnRzKCR0bXBfZGlyLicvVlguU2tl\nbGV0b24uemlwJywgZm9wZW4oJ2h0dHBzOi8vZ2l0aHViLmNvbS94aW1pazc3\nNy9WWC5Ta2VsZXRvbi9hcmNoaXZlL3YwLjAuMC56aXAnLCAncicpKTsKCiAg\nICBpZighbWtkaXIoJHBhdGgsIDA3NzUsIHRydWUpKXsKICAgICAgICBvdXQo\nMik7CiAgICB9CgogICAgJHppcCA9IG5ldyBaaXBBcmNoaXZlOwogICAgJHJl\ncyA9ICR6aXAtPm9wZW4oJHRtcF9kaXIuJy9WWC5Ta2VsZXRvbi56aXAnKTsK\nICAgIGlmICgkcmVzID09PSBUUlVFKSB7CiAgICAgICAgJHppcC0+ZXh0cmFj\ndFRvKCRwYXRoKTsKICAgICAgICAkemlwLT5jbG9zZSgpOwogICAgICAgIGVj\naG8gIlZYLlNrZWxldG9uLnppcCBleHRyYWN0ZWQgdG8gJHBhdGgiOwogICAg\nfSBlbHNlIHsKICAgICAgICBvdXQoMyk7CiAgICB9CgogICAgb3V0KDQpOwoK\nfQoKZnVuY3Rpb24gQWN0aW9uX3VwZGF0ZSgkcGF0aCkgewoKICAgICRhZ2Vu\ndCA9ICdWWC5Ta2VsZXRvbic7CgogICAgJGNoID0gY3VybF9pbml0KCk7CiAg\nICBjdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfVVNFUkFHRU5ULCAkYWdlbnQp\nOwogICAgY3VybF9zZXRvcHQoJGNoLCBDVVJMT1BUX1NTTF9WRVJJRllQRUVS\nLCBmYWxzZSk7CiAgICBjdXJsX3NldG9wdCgkY2gsIENVUkxPUFRfUkVUVVJO\nVFJBTlNGRVIsIHRydWUpOwovL2N1cmxfc2V0b3B0KCRjaCwgQ1VSTE9QVF9V\nUkwsICdodHRwczovL2FwaS5naXRodWIuY29tL3JlcG9zL3hpbWlrNzc3L1ZY\nLlNrZWxldG9uL2dpdC9ibG9icy82Yzg3MWU2NzZjMDY3ODk2ZmQyNDFmNzZl\nNDhlNmNhNmRmMmY4OTU3Jyk7CiAgICBjdXJsX3NldG9wdCgkY2gsIENVUkxP\nUFRfVVJMLCAnaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy94aW1pazc3\nNy9WWC5Ta2VsZXRvbi9jb250ZW50cy9iaW4vdngnKTsKICAgICRyZXN1bHQg\nPSBjdXJsX2V4ZWMoJGNoKTsKICAgIGN1cmxfY2xvc2UoJGNoKTsKCiAgICAk\nb2JqID0ganNvbl9kZWNvZGUoJHJlc3VsdCk7CgogICAgZWNobyAkb2JqLT5z\naGEuUEhQX0VPTDsKCiAgICBlY2hvIHNoYTFfZmlsZSgkcGF0aCkuUEhQX0VP\nTDsKICAgIGVjaG8gJHBhdGguUEhQX0VPTDsKCiAgICAkYSA9IGJhc2U2NF9l\nbmNvZGUoZmlsZV9nZXRfY29udGVudHMoJHBhdGgpKTsKCiAgICBpZigkYSA9\nPSAkb2JqLT5jb250ZW50KSB7CiAgICAgICAgZWNobyAxMjM7CiAgICAgICAg\nZGllKCk7CiAgICB9CgogICAgZWNobyAkYTsgZGllKCk7CgoKICAgIGlmIChz\naGExX2ZpbGUoJHBhdGgpID09ICRvYmotPnNoYSkgewogICAgICAgIG91dCgn\nbGF0ZXN0IHZlcnNpb24nKTsKICAgICAgICAvL3Rlc3QKICAgIH0KCiAgICBk\naWUoKTsKCiAgICAkdG1wID0gaGFzaCgnY3JjMzInLCB0aW1lKCkucmFuZCgx\nMTEsOTk5KSk7CgogICAgZmlsZV9wdXRfY29udGVudHMoJHBhdGgsIGZvcGVu\nKCdodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20veGltaWs3Nzcv\nVlguU2tlbGV0b24vbWFzdGVyL3Z4PycuJHRtcCwgJ3InKSk7CgogICAgZWNo\nbyAiVlggZmlsZSBzdWNjZXNzZnVsbHkgdXBkYXRlZCBhdCAkcGF0aCI7Cgog\nICAgb3V0KCk7Cgp9CgpmdW5jdGlvbiBvdXQoJGVyciA9IGZhbHNlKSB7CiAg\nICBnbG9iYWwgJHJldDsKICAgIHN3aXRjaCAoJGVycikgewoKICAgICAgICBj\nYXNlICdoZWxwJzoKICAgICAgICAgICAgZWNobygiIi5QSFBfRU9MLgogICAg\nICAgICAgICAgICAgIldlbGNvbWUgdG8gdGhlIHRlc3QgdngiLlBIUF9FT0wu\nCiAgICAgICAgICAgICAgICAiXGVbMzJtQXZhaWxhYmxlIGNvbW1hbmRzOlxl\nWzBtIi5QSFBfRU9MLgogICAgICAgICAgICAgICAgIlx0XGVbMzVtaGVscFxl\nWzBtIi5QSFBfRU9MLgogICAgICAgICAgICAgICAgIlx0XGVbMzVtbmV3IDxw\ncm9qZWN0X3BhdGg+XGVbMG0iLlBIUF9FT0wuCiAgICAgICAgICAgICAgICAi\nXHRcZVszNW11cGRhdGVcZVswbSIuUEhQX0VPTC4KICAgICAgICAgICAgICAg\nICIiLlBIUF9FT0wuCiAgICAgICAgICAgICAgICAiKGMpIFRlc3QgVlgiLlBI\nUF9FT0wKICAgICAgICAgICAgKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAg\nICAgY2FzZSAnbGF0ZXN0IHZlcnNpb24nOgogICAgICAgICAgICBlY2hvIFBI\nUF9FT0wuItCjINCy0LDRgSDRg9C20LUg0YHQutCw0YfQtdC90LAg0L/QvtGB\n0LvQtdC00L3Rj9GPINCy0LXRgNGB0LjRjyBWWCIuUEhQX0VPTDsKICAgICAg\nICAgICAgJHJldCA9MTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2Fz\nZSAxOgogICAgICAgICAgICBlY2hvIFBIUF9FT0wuItCj0LrQsNC20LjRgtC1\nINC40LzRjyDQv9GA0L7QtdC60YLQsCIuUEhQX0VPTDsKICAgICAgICAgICAg\nJHJldCA9MTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAyOgog\nICAgICAgICAgICBlY2hvIFBIUF9FT0wuItCd0LUg0YPQtNCw0LvQvtGB0Ywg\n0YHQvtC30LTQsNGC0Ywg0L/QsNC/0LrRgyDQv9C+INGD0LrQsNC30LDQvdC9\n0L7QvNGDINC/0YPRgtC4Ii5QSFBfRU9MOwogICAgICAgICAgICB1bmxpbmso\nc3lzX2dldF90ZW1wX2RpcigpLicvVlguU2tlbGV0b24uemlwJyk7CiAgICAg\nICAgICAgICRyZXQgPTE7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNh\nc2UgMzoKICAgICAgICAgICAgZWNobyBQSFBfRU9MLiLQndC1INGD0LTQsNC7\n0L7RgdGMINGA0LDRgdC/0LDQutC+0LLQsNGC0Ywg0LDRgNGF0LjQsiIuUEhQ\nX0VPTDsKICAgICAgICAgICAgdW5saW5rKHN5c19nZXRfdGVtcF9kaXIoKS4n\nL1ZYLlNrZWxldG9uLnppcCcpOwogICAgICAgICAgICAkcmV0ID0xOwogICAg\nICAgICAgICBicmVhazsKICAgICAgICBjYXNlIDQ6CiAgICAgICAgICAgIHVu\nbGluayhzeXNfZ2V0X3RlbXBfZGlyKCkuJy9WWC5Ta2VsZXRvbi56aXAnKTsK\nICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgZGVmYXVsdDoKICAgICAg\nICAgICAgZWNobyBQSFBfRU9MLiJIYXZlIGEgbmljZSBkYXkhIi5QSFBfRU9M\nOwogICAgICAgICAgICBicmVhazsKCiAgICB9CgoKICAgIGV4aXQoJHJldCk7\nCn0K\n";
//
//    echo base64_decode($test);
//    die();
    
    $agent = 'VX.Skeleton';

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_USERAGENT, $agent);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
//curl_setopt($ch, CURLOPT_URL, 'https://api.github.com/repos/ximik777/VX.Skeleton/git/blobs/6c871e676c067896fd241f76e48e6ca6df2f8957');
    curl_setopt($ch, CURLOPT_URL, 'https://api.github.com/repos/ximik777/VX.Skeleton/contents/bin/vx');
    $result = curl_exec($ch);
    curl_close($ch);

    $obj = json_decode($result);

    echo $obj->sha.PHP_EOL;

    echo sha1_file($path).PHP_EOL;
    echo $path.PHP_EOL;

    $a = chunk_split(base64_encode(file_get_contents($path)), $l=60, $e="\n");

    if($a == $obj->content) {
        echo 123;
        die();
    }

    echo $a; die();


    if (sha1_file($path) == $obj->sha) {
        out('latest version');
        //test
    }

    die();

    $tmp = hash('crc32', time().rand(111,999));

    file_put_contents($path, fopen('https://raw.githubusercontent.com/ximik777/VX.Skeleton/master/vx?'.$tmp, 'r'));

    echo "VX file successfully updated at $path";

    out();

}

function out($err = false) {
    global $ret;
    switch ($err) {

        case 'help':
            echo("".PHP_EOL.
                "Welcome to the test vx".PHP_EOL.
                "\e[32mAvailable commands:\e[0m".PHP_EOL.
                "\t\e[35mhelp\e[0m".PHP_EOL.
                "\t\e[35mnew <project_path>\e[0m".PHP_EOL.
                "\t\e[35mupdate\e[0m".PHP_EOL.
                "".PHP_EOL.
                "(c) Test VX".PHP_EOL
            );
            break;
        case 'latest version':
            echo PHP_EOL."У вас уже скачена последняя версия VX".PHP_EOL;
            $ret =1;
            break;
        case 1:
            echo PHP_EOL."Укажите имя проекта".PHP_EOL;
            $ret =1;
            break;
        case 2:
            echo PHP_EOL."Не удалось создать папку по указанному пути".PHP_EOL;
            unlink(sys_get_temp_dir().'/VX.Skeleton.zip');
            $ret =1;
            break;
        case 3:
            echo PHP_EOL."Не удалось распаковать архив".PHP_EOL;
            unlink(sys_get_temp_dir().'/VX.Skeleton.zip');
            $ret =1;
            break;
        case 4:
            unlink(sys_get_temp_dir().'/VX.Skeleton.zip');
            continue;
        default:
            echo PHP_EOL."Have a nice day!".PHP_EOL;
            break;

    }


    exit($ret);
}
